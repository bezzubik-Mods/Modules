# -*- coding: utf-8 -*-

from userbot import loader
import asyncio
from telethon.tl.functions.account import UpdateStatusRequest


@loader.Module
class GhostOfflineHeroku(loader.Module):
    """–ü–æ–ª–Ω—ã–π OFFLINE. –ß–∏—Å—Ç—ã–π –º–æ–¥—É–ª—å –ø–æ–¥ Heroku/Codraggo."""

    strings = {"name": "GhostOfflineHeroku"}

    def __init__(self):
        self._active = True
        self.client = None
        self.task = None

    async def client_ready(self, client, db):
        self.client = client
        self._active = True

        # –°—Ç–∞–≤–∏–º offline –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (–≤–∞–∂–Ω–æ –Ω–∞ Heroku)
        try:
            await client(UpdateStatusRequest(offline=True))
        except:
            pass

        # –ü–ï–†–ï–•–í–ê–¢ –ò –ë–õ–û–ö–ò–†–û–í–ö–ê –û–ù–õ–ê–ô–ù–ê
        # Codraggo –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–≤–æ–π sender –≤–Ω—É—Ç—Ä–∏ client._sender
        sender = getattr(client, "_sender", None)
        if sender is not None and hasattr(sender, "send_ping"):
            if not hasattr(sender, "_orig_send_ping"):

                sender._orig_send_ping = sender.send_ping

                async def no_ping(*args, **kwargs):
                    # –ü–æ–ª–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ª—é–±–æ–≥–æ –ø–∏–Ω–≥–∞
                    return None

                sender.send_ping = no_ping

        # —Å–æ–∑–¥–∞–µ–º —Ü–∏–∫–ª –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è offline
        self.task = asyncio.create_task(self._offline_loop())

    async def _offline_loop(self):
        while self._active:
            try:
                await self.client(UpdateStatusRequest(offline=True))
            except:
                pass
            await asyncio.sleep(7)

    async def ghostherokuoncmd(self, msg):
        """–í–∫–ª—é—á–∏—Ç—å Ghost Offline"""
        self._active = True
        self.task = asyncio.create_task(self._offline_loop())
        await msg.edit("üü¢ GhostOfflineHeroku –≤–∫–ª—é—á—ë–Ω")

    async def ghostherokuoffcmd(self, msg):
        """–í—ã–∫–ª—é—á–∏—Ç—å Ghost Offline"""
        self._active = False
        await msg.edit("‚ö™ GhostOfflineHeroku –≤—ã–∫–ª—é—á—ë–Ω")
