# -*- coding: utf-8 -*-
from ... import loader
import asyncio
from telethon.tl.functions.account import UpdateStatusRequest

# –í Codraggo Telethon sender –ª–µ–∂–∏—Ç –¢–£–¢:
try:
    from telethon.network.connection.connection import Connection
except:
    Connection = None


@loader.tds
class GhostOffline(loader.Module):
    """–ü–æ–ª–Ω—ã–π OFFLINE –¥–ª—è Heroku/Codraggo Userbot."""

    strings = {"name": "GhostOffline"}

    async def client_ready(self, client, db):
        self.client = client
        self._active = True

        # ---- 1. –°—Ç–∞–≤–∏–º offline —Å—Ä–∞–∑—É ----
        try:
            await client(UpdateStatusRequest(offline=True))
        except:
            pass

        # ---- 2. –ì–ª—É—à–∏–º –∞–≤—Ç–æ-–ø–∏–Ω–≥ Codraggo ----
        # –í Codraggo –º–µ—Ç–æ–¥ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è send_ping (–±–µ–∑ _)
        if Connection and hasattr(Connection, "send_ping"):
            if not hasattr(Connection, "_orig_send_ping"):

                Connection._orig_send_ping = Connection.send_ping

                async def no_ping(self, *a, **kw):
                    # –ë–ª–æ–∫–∏—Ä—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–∏–Ω–≥ => Telegram –ù–ï —Å—Ç–∞–≤–∏—Ç online
                    return None

                Connection.send_ping = no_ping

        # ---- 3. –¶–∏–∫–ª –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è offline ----
        self.task = asyncio.create_task(self._offline_loop())

    async def _offline_loop(self):
        while self._active:
            try:
                await self.client(UpdateStatusRequest(offline=True))
            except:
                pass
            await asyncio.sleep(6)

    async def ghostoncmd(self, m):
        """–í–∫–ª—é—á–∏—Ç—å GhostOffline"""
        self._active = True
        self.task = asyncio.create_task(self._offline_loop())
        await m.edit("üü¢ GhostOffline –≤–∫–ª—é—á—ë–Ω –¥–ª—è Codraggo")

    async def ghostoffcmd(self, m):
        """–í—ã–∫–ª—é—á–∏—Ç—å GhostOffline"""
        self._active = False
        await m.edit("‚ö™ GhostOffline –≤—ã–∫–ª—é—á—ë–Ω")
