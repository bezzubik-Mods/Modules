from hikka import loader, utils
from telethon.tl.types import ChatBannedRights
from telethon.tl.functions.channels import EditBannedRequest, GetParticipantRequest
from datetime import datetime, timedelta
import aiohttp


@loader.tds
class AntiSpamMod(loader.Module):
    """–ê–Ω—Ç–∏—Å–ø–∞–º –º–æ–¥—É–ª—å –¥–ª—è –≤–∞—à–µ–≥–æ —á–∞—Ç–∞!  
    –°–æ–∑–¥–∞—Ç–µ–ª—å: @–ë–µ–∑–∑—É–±–∏–∫ + AI –≤–µ—Ä—Å–∏—è"""

    strings = {"name": "AntiSpam"}

    def __init__(self):
        self.config = loader.ModuleConfig(
            "mute_hours", 10, "–í—Ä–µ–º—è –º—É—Ç–∞ (—á–∞—Å—ã)",
            "ban_hours", 24, "–í—Ä–µ–º—è –±–∞–Ω–∞ (—á–∞—Å—ã)",
            "punish_type", "mute", "–ù–∞–∫–∞–∑–∞–Ω–∏–µ: mute / ban / warn",
            "log_chat", None, "ID —á–∞—Ç–∞ –¥–ª—è –ª–æ–≥–æ–≤",
            "spam_trigger", 4, "–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–¥—Ä—è–¥ –¥–ª—è —Å–ø–∞–º–∞",
            "spam_period", 300, "–í—Ä–µ–º—è (—Å–µ–∫) –¥–ª—è —Å–ø–∞–º–∞",
            "flood_trigger", 5, "–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–¥—Ä—è–¥ –¥–ª—è —Ñ–ª—É–¥–∞",
            "flood_period", 60, "–í—Ä–µ–º—è (—Å–µ–∫) –¥–ª—è —Ñ–ª—É–¥–∞",
            "detect_mode", "hybrid", "–†–µ–∂–∏–º: classic / ai / hybrid",
            "use_gemini", False, "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Gemini –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–∞",
            "gemini_api_key", "", "API-–∫–ª—é—á Gemini (–µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω AI-–∞–Ω–∞–ª–∏–∑)"
        )
        self.spam_data = {}
        self.local_logs = []
        self.last_violator = None
        self.violators = 0
        self.enabled_chats = set()

    async def client_ready(self, client, db):
        self.client = client

    async def is_admin(self, chat_id, user_id):
        try:
            participant = await self.client(GetParticipantRequest(chat_id, user_id))
            part = participant.participant
            return getattr(part, "admin_rights", None) is not None or getattr(part, "rank", None)
        except Exception:
            return False

    async def ai_detect_spam(self, text: str) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ —Å–ø–∞–º —Å –ø–æ–º–æ—â—å—é Gemini API.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True, –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–µ.
        """
        if not self.config["use_gemini"] or not self.config["gemini_api_key"]:
            return False

        try:
            async with aiohttp.ClientSession() as session:
                headers = {"Content-Type": "application/json"}
                payload = {
                    "contents": [
                        {"parts": [{"text": f"–û–ø—Ä–µ–¥–µ–ª–∏, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–ø–∞–º–æ–º –∏–ª–∏ —Ä–µ–∫–ª–∞–º–æ–π:\n\n{text}\n\n–û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ True –∏–ª–∏ False."}]}
                    ]
                }
                async with session.post(
                    f"https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key={self.config['gemini_api_key']}",
                    headers=headers,
                    json=payload
                ) as resp:
                    data = await resp.json()
                    answer = data["candidates"][0]["content"]["parts"][0]["text"].lower()
                    return "true" in answer
        except Exception as e:
            print(f"[AntiSpam AI] –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ Gemini: {e}")
            return False

    async def watcher(self, event):
        chat_id = getattr(event, "chat_id", None)
        if not getattr(event, "is_group", False) or not getattr(event, "sender_id", None) or chat_id not in self.enabled_chats:
            return

        user_id = event.sender_id
        try:
            user = await event.get_sender()
        except Exception:
            return

        text = getattr(event, "message", "") or ""
        now = datetime.now()
        user_data = self.spam_data.get((chat_id, user_id), {"messages": []})
        user_data["messages"].append((now, text, getattr(event, "id", None)))
        self.spam_data[(chat_id, user_id)] = user_data
        period = max(self.config["spam_period"], self.config["flood_period"])
        user_data["messages"] = [(t, tx, mid) for t, tx, mid in user_data["messages"] if (now - t).seconds <= period]

        detect_mode = self.config["detect_mode"].lower()

        # 1Ô∏è‚É£ AI –∞–Ω–∞–ª–∏–∑
        if detect_mode in ["ai", "hybrid"]:
            try:
                if await self.ai_detect_spam(text):
                    await self.punish(chat_id, user, text, [getattr(event, "id", None)], "AI-–∞–Ω–∞–ª–∏–∑: –°–ü–ê–ú")
                    return
            except Exception as e:
                print(f"[AntiSpam AI] –û—à–∏–±–∫–∞: {e}")

        # 2Ô∏è‚É£ –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ (–µ—Å–ª–∏ classic –∏–ª–∏ hybrid)
        if detect_mode in ["classic", "hybrid"]:
            if len(user_data["messages"]) >= self.config["spam_trigger"]:
                last_msgs = user_data["messages"][-self.config["spam_trigger"]:]
                if len(set(tx for _, tx, _ in last_msgs)) == 1:
                    ids = [mid for _, _, mid in last_msgs if mid]
                    await self.punish(chat_id, user, text, ids, "–°–ü–ê–ú")
                    return
            if len(user_data["messages"]) >= self.config["flood_trigger"]:
                last_msgs = user_data["messages"][-self.config["flood_trigger"]:]
                if (now - last_msgs[0][0]).seconds <= self.config["flood_period"]:
                    ids = [mid for _, _, mid in last_msgs if mid]
                    await self.punish(chat_id, user, text, ids, "–§–õ–£–î")
                    return

    async def punish(self, chat_id, user, text, ids_to_delete, reason):
        user_id = user.id
        now = datetime.now()
        punishment_type = self.config["punish_type"].lower()
        is_admin = await self.is_admin(chat_id, user_id)
        until_time = None
        rights = None

        if not is_admin:
            if ids_to_delete:
                await self.client.delete_messages(chat_id, ids_to_delete)
            if punishment_type == "mute":
                until_time = now + timedelta(hours=self.config["mute_hours"])
                rights = ChatBannedRights(until_date=until_time, send_messages=True)
            elif punishment_type == "ban":
                until_time = now + timedelta(hours=self.config["ban_hours"])
                rights = ChatBannedRights(until_date=until_time, view_messages=True)
            if rights:
                try:
                    await self.client(EditBannedRequest(chat_id, user_id, rights))
                    self.violators += 1
                    self.last_violator = (user_id, user.first_name, until_time)
                except Exception:
                    pass
            msg = f"‚õî [{user.first_name}](tg://user?id={user_id}) –ø–æ–ª—É—á–∏–ª {punishment_type.upper()} –∑–∞ {reason}."
            if ids_to_delete:
                msg += f"\nüóë –£–¥–∞–ª–µ–Ω–æ {len(ids_to_delete)} —Å–æ–æ–±—â–µ–Ω–∏–π."
            if until_time:
                msg += f"\n‚è∞ –î–æ: {until_time.strftime('%Y-%m-%d %H:%M:%S')}"
            try:
                await self.client.send_message(chat_id, msg)
            except Exception:
                pass

        log = f"üì¢ –ê–Ω—Ç–∏—Å–ø–∞–º —Å—Ä–∞–±–æ—Ç–∞–ª\nüë§ [{user.first_name}](tg://user?id={user_id}) (`{user_id}`)\nüí¨ –ß–∞—Ç: `{chat_id}`\n‚ö† –ù–∞—Ä—É—à–µ–Ω–∏–µ: {reason}\n"
        if ids_to_delete and not is_admin:
            log += f"üóë –£–¥–∞–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {len(ids_to_delete)}\n"
        if punishment_type in ["mute", "ban"] and not is_admin and until_time:
            log += f"‚è∞ –ù–∞–∫–∞–∑–∞–Ω–∏–µ: {punishment_type.upper()} –¥–æ {until_time.strftime('%Y-%m-%d %H:%M:%S')}\n"
        elif punishment_type == "warn" and not is_admin:
            log += "‚ö† –ù–∞–∫–∞–∑–∞–Ω–∏–µ: WARN\n"
        if is_admin:
            log += "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω ‚Üí –Ω–∞–∫–∞–∑–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã\n"
        if text:
            log += f"üìù –°–æ–æ–±—â–µ–Ω–∏–µ: `{text}`"

        if self.config["log_chat"]:
            try:
                await self.client.send_message(self.config["log_chat"], log)
            except Exception:
                self.local_logs.append((datetime.now(), log))
        else:
            self.local_logs.append((datetime.now(), log))

        if len(self.local_logs) > 20:
            self.local_logs.pop(0)

    # ===================== –ö–æ–º–∞–Ω–¥—ã ===================== #

    @loader.unrestricted
    async def antispamtogglecmd(self, message):
        """–í–∫–ª—é—á–∏—Ç—å –∏–ª–∏ –≤—ã–∫–ª—é—á–∏—Ç—å –∞–Ω—Ç–∏—Å–ø–∞–º –≤ —ç—Ç–æ–º —á–∞—Ç–µ"""
        chat_id = message.chat_id
        if chat_id in self.enabled_chats:
            self.enabled_chats.remove(chat_id)
            await utils.answer(message, "‚ùå –ê–Ω—Ç–∏—Å–ø–∞–º –≤—ã–∫–ª—é—á–µ–Ω –≤ —ç—Ç–æ–º —á–∞—Ç–µ")
        else:
            self.enabled_chats.add(chat_id)
            await utils.answer(message, "‚úÖ –ê–Ω—Ç–∏—Å–ø–∞–º –≤–∫–ª—é—á—ë–Ω –≤ —ç—Ç–æ–º —á–∞—Ç–µ")

    @loader.unrestricted
    async def antispamstatuscmd(self, message):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∞–Ω—Ç–∏—Å–ø–∞–º–∞"""
        text = f"üìä –°—Ç–∞—Ç—É—Å –∞–Ω—Ç–∏—Å–ø–∞–º–∞\nüö´ –ù–∞—Ä—É—à–∏—Ç–µ–ª–µ–π: {self.violators}\n"
        text += f"üß† –†–µ–∂–∏–º: {self.config['detect_mode']}\nü§ñ Gemini: {'‚úÖ' if self.config['use_gemini'] else '‚ùå'}\n"
        if self.last_violator:
            uid, name, until_time = self.last_violator
            text += f"–ü–æ—Å–ª–µ–¥–Ω–∏–π: [{name}](tg://user?id={uid}) –¥–æ {until_time.strftime('%Y-%m-%d %H:%M:%S')}\n"
        else:
            text += "–ù–∞—Ä—É—à–∏—Ç–µ–ª–µ–π –ø–æ–∫–∞ –Ω–µ –±—ã–ª–æ."
        await utils.answer(message, text)

    @loader.owner
    async def setantispamcfgcmd(self, message):
        """–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∞–Ω—Ç–∏—Å–ø–∞–º–∞"""
        args = utils.get_args(message)
        if len(args) < 2:
            await utils.answer(message, "‚ö† –ò—Å–ø–æ–ª—å–∑—É–π: .setantispamcfg <–∫–ª—é—á> <–∑–Ω–∞—á–µ–Ω–∏–µ>")
            return
        key, value = args[0], " ".join(args[1:])
        if key not in self.config:
            await utils.answer(message, f"‚ùå –ù–µ—Ç —Ç–∞–∫–æ–≥–æ –∫–ª—é—á–∞: {key}")
            return
        try:
            if isinstance(self.config[key], bool):
                value = value.lower() in ["true", "1", "on", "yes", "–¥–∞"]
            elif isinstance(self.config[key], int):
                value = int(value)
            elif isinstance(self.config[key], float):
                value = float(value)
        except Exception:
            pass
        self.config[key] = value
        await utils.answer(message, f"‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ {key} –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ {value}")
